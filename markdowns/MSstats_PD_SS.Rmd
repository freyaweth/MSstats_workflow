---
title: "MSstats workflow"
author: "Sam Siljee"
date: '2022-11-18'
output: html_document
---

Created: 2022/11/18
Last modified: 2023/01/30
Written by: Sam Siljee

This is my script to run proteomics data from mass spectrometry through the `MSstats` package for normalisation, quantification, and some QC.
This is based on the following tutorial:

https://meenachoi.github.io/MayInstitute2019RstatsMS/

Please see the tutorial or the `MSstats` package help for details on how to use the package, for any other assistance or advice you can contact Sam at samsiljee@gmail.com or through his github:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Note that `MSstats` is a Bioconductor package, and will need to be installed through Biocondutor rather than CRAN; BiocManager::install("MSstats")
library(MSstats)
library(tidyverse)

# Specify input and output directories. Modify as appropriate
input_dir <- "~/Coding/MSstats-tutorial/data/OT_vs_IT/"
output_dir <- "~/Coding/MSstats-tutorial/data/OT_vs_IT/output/"
```

# Data import
This workflow is to import data at the PSM table from Proteome Discoverer 2.4 (PD). Although quantification and normalisation is done better in R, you still need to run all samples in the same analysis in order for PD to include precursor abundance in the output table.
After running the analysis in PD, select File > Export > To Text (tab delimited), and save with an appropriate name. Copy it to the input folder.
THis chunk reads in the raw PSM table and annotations file, and formats them for use by `MSstats`. 

```{r data import, echo = FALSE}
# Read raw data from PSM table
raw <- paste(input_dir, "15_50_quan_PSMs.txt", sep = "") %>%
  read.csv(sep = "\t", stringsAsFactors = FALSE)

# Manually add (rename) the columns required in the `PDtoMSstatsFormat` call
raw <- raw %>%
  mutate(ProteinGroupAccessions = .$Protein.Accessions,
         PrecursorArea = .$Precursor.Abundance,
         Run = .$Spectrum.File)

# Read annotations file. This should at least include columns for run, condition, and biological replicate. Every row should be a seperate run
annot_col <- read.csv("~/Coding/MSstats-tutorial/data/OT_vs_IT/col_annotation.csv",
                      sep = ",",
                      stringsAsFactors = TRUE)

# Format for `MSstats`. Please see ?PDtoMSstatsFormat for details on arguments
input <- PDtoMSstatsFormat(raw, 
                           annotation = annot_col,
                           removeProtein_with1Peptide = FALSE,
                           which.quantification = "Precursor.Abundance",
                           which.proteinid = "Protein.Accessions",
                           removeFewMeasurements = TRUE)

# Briefly check input
head(input)

# Count the number of proteins
input$ProteinName %>% unique %>% length
```

# Data Processing
This chunk processes the input data including normalisation, censored cutoff, and protein-level summarization. It saves the result in the output folder in the R data format. Please see `?dataProcess` for details on arguments, normalisation methods etc.

```{r data processing, echo = FALSE}
# Process the input
processed.quant <- dataProcess(input,
                               normalization = 'equalizeMedians',
                               summaryMethod="TMP",
                               censoredInt="NA",
                               MBimpute=TRUE,
                               maxQuantileforCensored=0.999)

# Save results
save(processed.quant, file = paste(output_dir, "processed.quant.rda", sep = ""))
```

# Data visualisation

```{r data visualisation, echo = FALSE}
# This produces a boxplot, of intensity by sample. Used as a basic way to check normalisation
dataProcessPlots(processed.quant, type="QCplot", 
                 ylimDown=0, 
                 which.Protein = 'allonly',
                 width=7, height=7,  
                 address="data/OT_vs_IT/output/ControlMixture_DDA_ProteomeDiscoverer_")

# Produces individual plots for the different proteins, each peptide shown in a different colour
dataProcessPlots(processed.quant, type="Profileplot", 
                 ylimDown=0, 
                 originalPlot = TRUE,
                 summaryPlot = TRUE,
                 width=7, height=7,  
                 address="data/OT_vs_IT/output/ControlMixture_DDA_ProteomeDiscoverer_")

# Produces a plot for each protein, with the estimated abundance for each protein as based on the modified mixed linear effects model used by `MSstats`
dataProcessPlots(processed.quant, type="Conditionplot", 
                 ylimDown=0, 
                 width=7, height=7,  
                 address="data/OT_vs_IT/output/ControlMixture_DDA_ProteomeDiscoverer_")
```

## Model-based comparison, and adjusted p-value

```{r model based comparison, echo = FALSE}
# Set up a comparison, see the `MSstats` example on how to set up a comparison matrix for more than two conditions
comparison <- matrix(c(1, 1, 1, -1, -1),nrow=1)
row.names(comparison)<-c("15cm-50cm")
colnames(comparison) <- c("15cm", "15cm", "15cm", "50cm", "50cm")

test.MSstats <- groupComparison(contrast.matrix=comparison, data=processed.quant)
test.MSstats <- test.MSstats$ComparisonResult

# save the results
save(test.MSstats, file='data/Proteome_Discoverer_example/output/test.MSstats.rda')
write.csv(test.MSstats, file='data/Proteome_Discoverer_example/output/ControlMixture_DDA_ProteomeDiscoverer_testResult_byMSstats.csv')
```

# Comparison plots

```{r comparison plots, echo = FALSE}
groupComparisonPlots(data=test.MSstats, type="VolcanoPlot",
                     width=6, height=6,
                     address="data/Proteome_Discoverer_example/output/ControlMixture_DDA_ProteomeDiscoverer_")

groupComparisonPlots(data=test.MSstats, type="ComparisonPlot",
                     width=6, height=6,
                     address="data/Proteome_Discoverer_example/output/ControlMixture_DDA_ProteomeDiscoverer_")

```